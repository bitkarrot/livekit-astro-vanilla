document.addEventListener("DOMContentLoaded",()=>{const m=document.getElementById("video-preview"),v=document.getElementById("microphone-toggle"),k=document.getElementById("microphone-dropdown-button"),o=document.getElementById("microphone-dropdown"),g=document.getElementById("camera-toggle"),y=document.getElementById("camera-dropdown-button"),c=document.getElementById("camera-dropdown"),p=document.getElementById("username"),I=document.getElementById("join-btn");let d=null,r=localStorage.getItem("livekit-video-enabled")!=="false",u=localStorage.getItem("livekit-audio-enabled")!=="false",s=localStorage.getItem("livekit-audio-device")||null,l=localStorage.getItem("livekit-video-device")||null;const L=localStorage.getItem("livekit-username");L&&p&&(p.value=L),w(),v.addEventListener("click",()=>{u=!u,h(),d&&d.getAudioTracks().forEach(e=>{e.enabled=u})}),g.addEventListener("click",()=>{r=!r,b(),d&&d.getVideoTracks().forEach(e=>{e.enabled=r})}),k.addEventListener("click",e=>{e.stopPropagation(),o.classList.toggle("hidden"),c.classList.contains("hidden")||c.classList.add("hidden")}),y.addEventListener("click",e=>{e.stopPropagation(),c.classList.toggle("hidden"),o.classList.contains("hidden")||o.classList.add("hidden")}),document.addEventListener("click",e=>{e.target.closest(".device-control")||(o.classList.add("hidden"),c.classList.add("hidden"))});function h(){u?v.classList.remove("disabled"):v.classList.add("disabled")}function b(){r?g.classList.remove("disabled"):g.classList.add("disabled")}async function w(){try{await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});const e=await navigator.mediaDevices.enumerateDevices();S(e),f()}catch(e){console.error("Error initializing device preview:",e);const i=document.getElementById("permissions-warning");i&&i.classList.remove("hidden")}}function S(e){const i=e.filter(t=>t.kind==="audioinput"),a=e.filter(t=>t.kind==="videoinput");if(o.innerHTML="",i.forEach(t=>{const n=document.createElement("button");n.textContent=t.label||`Microphone ${i.indexOf(t)+1}`,n.dataset.deviceId=t.deviceId,n.addEventListener("click",()=>{s=t.deviceId,f(),o.classList.add("hidden"),o.querySelectorAll("button").forEach(E=>{E.classList.remove("active")}),n.classList.add("active")}),t.deviceId===s&&n.classList.add("active"),o.appendChild(n)}),c.innerHTML="",a.forEach(t=>{const n=document.createElement("button");n.textContent=t.label||`Camera ${a.indexOf(t)+1}`,n.dataset.deviceId=t.deviceId,n.addEventListener("click",()=>{l=t.deviceId,f(),c.classList.add("hidden"),c.querySelectorAll("button").forEach(E=>{E.classList.remove("active")}),n.classList.add("active")}),t.deviceId===l&&n.classList.add("active"),c.appendChild(n)}),!s&&i.length>0){s=i[0].deviceId;const t=o.querySelector("button");t&&t.classList.add("active")}if(!l&&a.length>0){l=a[0].deviceId;const t=c.querySelector("button");t&&t.classList.add("active")}}async function f(){try{d&&d.getTracks().forEach(a=>a.stop());const e={audio:s?{deviceId:{exact:s}}:!0,video:l?{deviceId:{exact:l}}:!0};d=await navigator.mediaDevices.getUserMedia(e),d.getAudioTracks().forEach(a=>{a.enabled=u}),d.getVideoTracks().forEach(a=>{a.enabled=r});let i=m.querySelector("video");i||(i=document.createElement("video"),i.autoplay=!0,i.muted=!0,i.playsInline=!0,m.innerHTML="",m.appendChild(i)),i.srcObject=d}catch(e){console.error("Error starting media preview:",e);const i=document.getElementById("permissions-warning");i&&i.classList.remove("hidden")}}I&&I.addEventListener("click",()=>{localStorage.setItem("livekit-audio-enabled",u.toString()),localStorage.setItem("livekit-video-enabled",r.toString()),localStorage.setItem("livekit-audio-device",s||""),localStorage.setItem("livekit-video-device",l||"");const e=p.value.trim();e&&localStorage.setItem("livekit-username",e)}),h(),b()});
